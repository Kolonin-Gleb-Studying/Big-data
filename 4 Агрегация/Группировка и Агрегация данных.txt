-- Практика по агрегации данных
/*
Агрегация данных это процесс объединения записей из таблиц с помощью специальных функций.
Агрегация данных нужна, когда необходимо не просто вывести что-то, а рассчитать какой-то показатель, по имеющимся данным.
*/

-- Группировка
-- GROUP BY - оператор позволяющий задать условие (сгрупировать данные)
-- по которому будут работать агрегирующие функции.

SELECT * FROM oe.orders;

-- Кол. заказов, сгруппированные по типу их оформления (онл или офл).
-- Позволяет посчитать кол. онл. и офл. заказов

SELECT 
    COUNT(*),
    ORDER_MODE
FROM oe.orders
GROUP BY ORDER_MODE;
-- Благодаря GROUP BY функция агрегации COUNT работает для каждого типа заказа, по заданном условию.

-- ВАЖНО:
-- При агрегации в SELECT НЕ МОЖЕТ БЫТЬ не агрегируемых полей
-- Т.к. агрегируемые данные выводятся для ряда записей, а не для конкретного значения в одном столбце 
-- SELECT
--     round(AVG(salary), 3),
--     first_name
-- FROM hr.employees;


-- 1) Самые высокооплачиваемые сотрудники каждого департамента
-- Решение через подзапрос и соединение JOIN

-- А Вот тут при агрегации данных в SELECT МОГУТ БЫТЬ не агрегируемые поля
-- Они разрешены, т.к. указаны в GROUP_BY
-- Выборка макс. ЗП в каждом департаменте!

SELECT 
    t1.first_name,
    t1.last_name,
    t1.DEPARTMENT_ID
FROM hr.employees t1
INNER JOIN (
    SELECT 
        DEPARTMENT_ID,
        max(salary) as max_salary
    FROM hr.employees t2
    GROUP BY department_id
) t2
ON t1.department_id = t2.department_id AND t1.salary = t2.max_salary;
